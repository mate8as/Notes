@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject DarkModeSwitchStateContainer DarkModeSwitchStateContainer
@inject UserManager<User> UserManager
@inject ISnackbar Snackbar

@page "/"
@page "/home"


<MudStack Spacing="10">
    <MudTextField T="string" Typo="Typo.h4" Class="mt-5 ms-3" Variant="Variant.Text" Required="true" RequiredError="Email is required!" @bind-Value="NoteTitle" Style="max-width: 25%;" />

    <RichTextEditor isDarkModeOn="DarkModeSwitchStateContainer.GetDarkMode()" Content="@Note.RawContent" ContentChanged="OnContentChanged"></RichTextEditor>

    @foreach (KeyValuePair<string, (int cursorX, int cursorY)> cursor in OtherUserCursors)
    {
        <MudAvatar Color="Color.Primary" Style="@($"position: absolute; top: {cursor.Value.cursorY}px; left: {cursor.Value.cursorX}px;")">M</MudAvatar>
    }
</MudStack>



@code {
    [Inject] IJSRuntime JS { get; set; }

    [Parameter] 
    public string NoteId { get; set; } = "1";

    private HubConnection hubConnection;

    private NoteFile Note = new NoteFile();
    private string NoteTitle = "Untitled note";

    private string userId = Guid.NewGuid().ToString();
    private Dictionary<string, (int cursorX, int cursorY)> OtherUserCursors = new();

    private User? currentUser = null;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated == true)
        {
            // You can access claims like email or name
            var email = user.FindFirst(c => c.Type == ClaimTypes.Email)?.Value;

            // Or fetch full IdentityUser from the database
            currentUser = await UserManager.FindByEmailAsync(email);
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var lDotNetReference = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("setDotnetReference", lDotNetReference);

            await JS.InvokeVoidAsync("console.log", "All cookies: " + await JS.InvokeAsync<string>("eval", "document.cookie"));


            hubConnection = new HubConnectionBuilder().WithUrl(Navigation.ToAbsoluteUri("/noteshub")).WithAutomaticReconnect().Build();


            hubConnection.On<string, string>("ReceiveContentUpdate", async (newContent, senderId) =>
            {
                if (senderId == userId)
                    return;

                Note.RawContent = newContent;
                await InvokeAsync(StateHasChanged);
            });

            hubConnection.On<string, int, int>("ReceiveCursorUpdate", async (otherUserId, positionX, positionY) =>
            {
                OtherUserCursors[otherUserId] = (positionX, positionY);
                await InvokeAsync(StateHasChanged);
            });

            await hubConnection.StartAsync();
            await hubConnection.SendAsync("JoinNote", NoteId);

            DarkModeSwitchStateContainer.OnDarkModeChanged += async () => await InvokeAsync(StateHasChanged);
        }

        
        AuthNotificationHandler();
        base.OnAfterRender(firstRender);
    }

    private void AuthNotificationHandler()
    {
        if (currentUser != null && BlazorCookieLoginMiddleware.PendingNotifications.TryGetValue(currentUser.UserName, out var notification))
        {
            Snackbar.Add($"{notification.Event}", notification.Severity);
            BlazorCookieLoginMiddleware.PendingNotifications.Remove(currentUser.UserName);
        }
    }

    private async Task OnContentChanged(string content)
    {
        Note.RawContent = content;
        await hubConnection.SendAsync("UpdateContent", NoteId, content, userId);
    }

    [JSInvokable]
    public async Task OnCursorMoved(int cursorX, int sursorY)
    {
        if (hubConnection == null)
        {
            return;
        }

        await hubConnection.SendAsync("UpdateCursor", NoteId, userId, cursorX, sursorY);
    }

    public async ValueTask DisposeAsync()
    {
        if (hubConnection is not null)
        {
            await hubConnection.SendAsync("LeaveNote", NoteId);
            await hubConnection.DisposeAsync();
        }
    }

}